// recursiveTiffConvert.txt
// Written by Curtis Rueden
// Last updated on 2008 May 6

// Recursively converts files to TIFF using Bio-Formats.

// It was originally written to convert Gatan DM3 files, but you can easily
// change the code to work with any or all extensions of your choice.

ext = "DM3"; // this variable controls the extension of source files

requires("1.39u");
inDir = getDirectory("Choose Directory Containing " + ext + " Files ");
outDir = getDirectory("Choose Directory for TIFF Output ");
setBatchMode(true);
processFiles(inDir, outDir, "");
print("-- Done --");

function processFiles(inBase, outBase, sub) {
  flattenFolders = true; // this flag controls output directory structure
  print("-- Processing folder: " + sub + " --");
  list = getFileList(inBase + sub);
  if (!flattenFolders) File.makeDirectory(outBase + sub);
  for (i=0; i<list.length; i++) {
    path = sub + list[i];
    if (endsWith(path, "/")) {
      // recurse into subdirectories
      processFiles(inBase, outBase, path);
    }
    upath = toUpperCase(path);
    else if (endsWith(upath, "." + ext)) {
      print("-- Processing file: " + path + " --");
      run("Bio-Formats Importer", "id='" + inBase + path + "' view=[Standard ImageJ] stackOrder=Default virtual");
      outFile = path + ".tif";
      if (flattenFolders) outFile = replace(outFile, "/", "_");
      saveAs("Tiff", outBase + outFile);
      close();
    }
  }
}
